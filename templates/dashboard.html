<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zixt - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Threads</h2>
            <ul id="thread-list">
                {% for thread in threads %}
                    <li>
                        <a href="{{ url_for('thread', thread_id=thread[0]) }}">
                            {{ thread[2] }} {% if thread[1] == session['user_id'] %}(Creator){% endif %}
                        </a>
                        <form method="POST" action="{{ url_for('delete_thread', thread_id=thread[0]) }}" style="display:inline;">
                            {{ form.hidden_tag() }}
                            <button type="submit" onclick="return confirm('Delete this thread for you?')">Delete</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
            <h3>Create New Thread</h3>
            <form method="POST" action="{{ url_for('create_thread') }}">
                {{ thread_form.hidden_tag() }}
                {{ thread_form.participants(multiple="multiple") }}<br>
                {{ thread_form.submit() }}
            </form>
            <a href="{{ url_for('logout') }}">Logout</a>
            {% if is_admin %}
                | <a href="{{ url_for('admin') }}">Admin</a>
            {% endif %}
        </div>
        <div class="main">
            {% if thread_id %}
                <h1>Thread #{{ thread_id }}</h1>
                {% if creator_id == session['user_id'] %}
                    <form method="POST" action="{{ url_for('add_participant', thread_id=thread_id) }}">
                        <select name="user_id">
                            {% for user in users %}
                                <option value="{{ user[0] }}">{{ user[1] }}</option>
                            {% endfor %}
                        </select>
                        <button type="submit">Add Participant</button>
                    </form>
                    {% for participant in participants %}
                        {% if participant[0] != session['user_id'] %}
                            <form method="POST" action="{{ url_for('remove_participant', thread_id=thread_id, user_id=participant[0]) }}" style="display:inline;">
                                {{ form.hidden_tag() }}
                                <button type="submit">Remove {{ participant[1] }}</button>
                            </form>
                        {% endif %}
                    {% endfor %}
                {% endif %}
                <div id="messages">
                    {% for msg in messages %}
                        <div class="message">
                            <strong>{{ 'You' if msg[0] == session['user_id'] else 'Them' }}:</strong> {{ msg[1] }}
                            {% if msg[2] %}
                                {% if msg[2].endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                                    <img src="{{ url_for('static', filename='uploads/' + msg[2]) }}" alt="Attachment" style="max-width: 200px;">
                                {% else %}
                                    <a href="{{ url_for('static', filename='uploads/' + msg[2]) }}" target="_blank">{{ msg[2] }}</a>
                                {% endif %}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    {{ form.message(placeholder="Type your message") }}<br>
                    {{ form.file() }}<br>
                    {{ form.submit() }}
                </form>
            {% else %}
                <h1>Welcome to Zixt</h1>
                <p>Select a thread or create a new one to start messaging.</p>
            {% endif %}
        </div>
    </div>
    <script>
        var threadId = {{ thread_id|default('null')|tojson }};
        var baseUrl = "{{ base_url }}";
    </script>
</body>
</html>